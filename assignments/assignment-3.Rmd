---
title: "Almond Profits"
author: "Fletcher McConnell and Maxwell Patterson"
date: "2024-04-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(purrr)
library(ggpubr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyr)
library(here)
```

```{r}
# Read in functions
source(here("assignments/almond-yield.R"))
source(here("assignments/profit-func.R"))
print("Functions read in successfully!")
```


```{r}
# Get almond anomaly dataframe ------
# Read in climate data
clim_df <- read.table(here("Data/clim.txt"), header=TRUE)

# Define model parameters (from Table 2 in paper)
model_params <- list(
  intercept = 0.28,
  a = -0.015,
  b = -0.0046,
  c = -0.07,
  d = 0.0043
)

# Run function
yields <- almond_model(clim_df, model_params)

# Display summary stats of yield anomaly amounts
print(summary(yields$yield_anomaly))
```

```{r}
# Calculating profits by year with set parameters
profits <- almond_profit_detailed(yields, base_yield = 1.5, price = 1000, total_cost = 3000, acres = 5)
print(profits)
```


We want to vary the price and cost of almonds per year. These values will vary depending on environmental and market tendencies.


```{r}
price_variations <- rnorm(mean=4000, sd = 200, n=20)

# Calculate profits for each price variation
profit_distribution <- price_variations %>%
  map(~almond_profit_detailed(yields, base_yield = 1.5, price = .x, total_cost = 3000, acres = 5))

# Extract annual profit data and reformat as a data frame
annual_profit_data <- map_df(profit_distribution, `[`, c("profit"))
profit_distribution_df <- data.frame(year = yields$year, 
                                     net_profit = annual_profit_data$profit)

# Calculate average profits across price variations
average_profit_by_year <- profit_distribution_df %>%
  group_by(year) %>%
  dplyr::summarize(mean_net_profit = mean(net_profit))

# Plot the profit distribution
ggplot(profit_distribution_df, aes(year, net_profit, group=year)) + 
  geom_boxplot() + 
  labs(y = "Net Profit ($)") +
  geom_line(data=average_profit_by_year, aes(year, mean_net_profit, group=1), col="blue")

# Calculate mean profit over all years for each price variation
mean_profit_by_price = data.frame(price = price_variations, mean_net_profit = map_dbl(profit_distribution, ~mean(.x$profit)))

# Plot the distribution of mean profits
ggplot(mean_profit_by_price, aes(y = mean_net_profit)) + 
  geom_boxplot() +
  labs(y = "Net Profit ($)")

# Plot the sensitivity of mean profit to price
ggplot(mean_profit_by_price, aes(price, mean_net_profit)) + 
  geom_point() +
  labs(y = "Net Profit in Dollars", x = "Almond Production Price")
```



```{r}
yield_variations <- rnorm(mean=1.5, sd = 0.3, n=20)

# Calculate profits for each yield variation
yield_profit_distribution <- yield_variations %>%
  map(~almond_profit_detailed(yields, base_yield = .x, price = 1000, total_cost = 3000, acres = 5))

# Extract annual profit data and reformat as a data frame
annual_yield_profit_data <- map_df(yield_profit_distribution, `[`, c("profit"))
yield_distribution_df <- data.frame(year = yields$year, 
                                    net_profit = annual_yield_profit_data$profit)

# Calculate average profits across yield variations
average_yield_profit_by_year <- yield_distribution_df %>% 
  group_by(year) %>% 
  dplyr::summarize(mean_net_profit = mean(net_profit))

# Plot the profit distribution
ggplot(yield_distribution_df, aes(year, net_profit, group=year)) + 
  geom_boxplot() + 
  labs(y = "Net Profit ($)") +
  geom_line(data=average_yield_profit_by_year, aes(year, mean_net_profit, group=1), col="blue")

# Calculate mean profit over all years for each yield variation
mean_profit_by_yield <- data.frame(yield = yield_variations, 
                                   mean_net_profit = map_dbl(yield_profit_distribution, ~mean(.x$profit)))

# Plot the distribution of mean profits
ggplot(mean_profit_by_yield, aes(y = mean_net_profit)) + 
  geom_boxplot() +
  labs(y = "Net Profit in Dollars")

# Plot the sensitivity of mean profit to yield
ggplot(mean_profit_by_yield, aes(yield, mean_net_profit)) + 
  geom_point() +
  labs(y = "Net Profit in Dollars", x = "Almond Yield in tons/acre")
```





































